# DEV.md

## 概要
- イラスト模写支援アプリケーションの設計
- ブラウザで動作するWebアプリケーション
- 画面を左右に分割し、以下のような機能をそれぞれ提供する：
	- イラストを読み込み、お手本として表示する（左）
	- 簡単なドローイング機能を提供し、模写練習ができる（右）

## 機能要件
### お手本画面
- お手本画像は保存できる
	- 後から開き直すこともできるようにする
	- ファイルの実体はWebアプリケーションが起動しているサーバのローカルに保存する
	- 既に保存済みのお手本画像を読み込もうとした場合、警告を表示してから既存のお手本を読み込む
- お手本にはグリッドをオーバーレイできる
	- グリッドの縦横間隔、グリッド線の太さなどは簡単に変更できる
- お手本画面では点と点の長さを測定したり、線と線の角度を測定できる
	- 測定結果は永続化し、お手本を読み込んだ時に復元できる
### ドローイング画面
- ペンの太さを変更できる
	- px単位で指定する
	- 最初は固定値でよい
- ペンの色を変更できる
	- カラーピッカーで色を選択できる
	- 最初は黒のみでよい
- 描いた絵は保存できる
	- お手本のIDと紐付ける。お手本を読み込むと描いた絵が一覧できる
### 共通
- ドローイング画面で描いた絵にお手本を重ねて、ずれを可視化できる
- 左右両方の画面をそれぞれ左右反転して、歪みを確認できる

## 技術要件
- Viteサーバ + ReactのシンプルなWebアプリとする
- 永続化が必要なデータにはSQLiteを用いる
- テストフレームワークとしてVitestを使用する

## Logs

### 2025/6/16 - プロジェクト確認
- リポジトリ内容を確認
- 現在の状態：初期Vite+Reactテンプレート
- 設計仕様をDEV.mdで確認完了

#### MVP構成要素の考察
**必須機能（Core MVP）**
- お手本画像のアップロード・表示
- 基本的な固定間隔グリッドオーバーレイ
- Canvas要素での基本描画機能
- ペンの太さ調整（3-4段階）
- 描画クリア機能
- 左右分割レイアウト

**重要だが後回し可能**
- 描画データ永続化
- お手本画像保存
- 測定機能
- 重ね合わせ機能
- 左右反転
- カラーピッカー

**技術選択**
- フロントエンド：React + Canvas API + CSS Grid
- 永続化は後回し（LocalStorageで代替検討）

#### 実装開始点の検討
**実装順序（TDD前提）**
1. テスト環境構築（Vitest + Testing Library）
2. 基盤レイアウト（左右分割）
3. お手本表示機能（ファイルアップロード・画像表示・グリッド）
4. 描画機能（Canvas描画・ペン設定）

**理由**
- テスト環境を最初に構築してTDD体制確立
- レイアウトでコンポーネント境界を明確化
- お手本機能でユーザー体験の基礎を構築
- Canvas描画は複雑なため最後に集中

### テスト環境構築完了
- Vitest + React Testing Library + jsdom導入
- 基本テストユーティリティ作成（src/test/test-utils.tsx）
- テストスクリプト追加（test, test:ui, test:run）
- 動作確認完了（2テスト通過）

### 基盤レイアウト実装完了（TDD）
- SplitLayoutコンポーネント作成
  - 左右分割（お手本表示/描画エリア）
  - アクセシビリティ対応（role, aria-label）
  - CSS Grid使用
- ウィンドウフルスクリーン対応
  - body, html, #rootの制約解除
  - 100vw × 100vh完全活用
  - 明るいテーマに変更（描画アプリに適用）
- テスト5件全通過

### お手本表示機能実装完了（TDD）
- ImageUploadコンポーネント（5テスト）
  - ファイル選択・ドラッグ&ドロップ対応
  - 画像ファイル形式検証
- ImageDisplayコンポーネント（6テスト）
  - 画像表示・プレースホルダー表示
  - レスポンシブ対応
- GridOverlayコンポーネント（6テスト）
  - SVGベースグリッド描画
  - サイズ・色・線幅カスタマイズ
- ReferencePanelコンポーネント（7テスト）
  - 上記3コンポーネント統合
  - グリッド設定UI
  - 状態管理（画像・グリッド設定）
- App.tsxに統合完了
- 全30テスト通過

### 描画機能実装完了（TDD）
- DrawingCanvasコンポーネント（9テスト）
  - マウス描画対応（mousedown/move/up）
  - Canvas API使用
  - ペン設定適用（太さ・色）
  - クリア機能
- PenControlsコンポーネント（11テスト）
  - ペンサイズ調整（1-100px）
  - プリセットサイズ（細・中・太）
  - カラーピッカー
  - バリデーション機能
- DrawingPanelコンポーネント
  - 上記2コンポーネント統合
  - 状態管理（ペン設定）
- App.tsxに統合完了
- 全50テスト通過

### Canvas座標ズレ修正
- ウィンドウサイズ変更時の座標ズレ問題を修正
- Canvas要素のスケーリング対応
  - 表示サイズと内部座標系のスケール比計算
  - マウス座標の正確な変換
- スケーリングテストケース追加（1テスト）
- 全51テスト通過

### UI/UX改善調整
- ペンの太さを1/2/3pxに調整
  - プリセットサイズ変更（細1px・中2px・太3px）
  - デフォルトサイズ1pxに変更
- お手本とキャンバスの真横配置実現
  - コントロール部分の高さ統一（120px固定）
  - パディング調整で縦位置揃え
  - 模写しやすいレイアウト完成
- 全51テスト通過

### グリッド機能拡張・サイズ同期実装
- 背景色調整機能実装
  - お手本・描画エリア以外を薄いグレー（#f5f5f5）に色付け
  - コントロールパネルは白色のまま維持
- グリッド同期機能実装
  - 描画画面にもグリッドオーバーレイ表示
  - App.tsxでグリッド設定を一元管理
  - 両画面で同じグリッド設定を共有
- グリッド表示範囲最適化
  - お手本画像のグリッドを画像サイズに限定
  - ImageDisplayにサイズ検出機能追加（ResizeObserver）
  - 描画領域のサイズをお手本画像と同期
- コンポーネント間の状態共有強化
  - ReferencePanel → ImageDisplay → App.tsx → DrawingPanel → DrawingCanvas
  - 画像サイズ情報の伝播とキャンバスサイズ同期
- テスト更新・修正
  - ResizeObserverのモック追加
  - 新しいプロパティに対応したテストケース修正
  - 全51テスト通過維持

### 性能問題修正・描画領域最適化
- 描画性能問題とグリッド表示問題を修正
  - 複雑な状態連携による負荷増大問題を解決
  - ペンのガタガタ現象解消
- 前バージョンの仕様に復帰
  - サイズ同期の複雑な実装を単純化
  - コンポーネント間の不要な依存関係を除去
  - ImageDisplayのResizeObserver機能を削除
- 描画側領域の全面表示実装
  - 描画キャンバスを固定サイズ（800×600）に戻す
  - 描画エリアを全面表示に変更（position: absolute + center配置）
  - 背景色調整維持（#f5f5f5）
  - お手本画像サイズに関係なく自由に模写可能
- グリッド表示の正常化
  - 両画面でグリッド表示が正常に動作
  - シンプルなオーバーレイ実装を維持
- 全51テスト通過維持

### 真の全面描画・固定サイズ表示実装
- 描画領域をゾーン全面に拡大（可変サイズ）
  - ResizeObserverでコンテナサイズを監視
  - キャンバスサイズを動的に調整
  - position: absolute + 100%幅高さで完全活用
  - ゾーンサイズ変更に即座に対応
- お手本画像をリサイズせずに表示
  - 画像の元サイズを保持
  - overflow: autoでスクロール可能
  - position: absolute + top-left固定配置
  - ウィンドウサイズ変更による影響を排除
- グリッドと画像の位置関係を固定
  - グリッドをコンテナ全体にオーバーレイ
  - 画像位置に関係なく一定のグリッド表示
  - スクロール時もグリッドは固定位置
  - 正確な位置関係での模写練習が可能
- 全51テスト通過維持

### UI微調整・操作パネル最適化
- ペン設定を横並びレイアウトに変更
  - ペンの太さとペンの色をFlexboxで横並び配置
  - ペンの太さ（左側）：入力フィールド + プリセットボタン
  - ペンの色（右側）：カラーピッカー
  - 両パネルの高さを170pxに統一調整（プリセットボタン含む）
  - スクロール不要で全要素が快適に表示
- ペン設定レイアウト・スペーシング最適化
  - 要素間スペーシングを20px（1.25rem）に統一
  - min-width: 0でFlexbox要素のはみ出し防止
  - プリセットボタンのサイズ調整とflex-wrap追加
  - 将来の要素追加に対応した拡張性の高い設計
- 全51テスト通過維持

### 個別角丸スタイル実装・UI統一化
- ペン設定パネルの背景を個別要素に分離
  - pen-controlsコンテナ背景を削除
  - ペンの太さ・ペンの色をそれぞれ個別の角丸領域で囲み
  - background-color: #f9f9f9 + border-radius: 8px + border追加
- 操作パネル高さを最終調整
  - 個別角丸スタイルに合わせて20px増加（170px → 190px）
  - ReferencePanel・DrawingPanel両方の高さ統一
- ペン設定専用の個別角丸デザイン
  - グリッド設定は元のシンプルなデザインを維持
  - ペン設定のみ個別要素スタイルを適用
  - 機能に応じたデザインの使い分けを実現
- 全51テスト通過維持

### クリアボタン移動・グリッド位置修正
- 描画領域のクリアボタンをペン設定パネルに移動
  - DrawingCanvasからクリアボタンとonClearプロップを削除
  - PenControlsにonClearプロップとクリアボタンを追加
  - 右下端に配置（position: absolute + bottom/right指定）
  - 赤色系の目立つスタイル適用（#ff4444 → #cc3333 hover）
- グリッド表示位置の正常化
  - クリアボタンによるレイアウト影響を排除
  - 描画領域のグリッドが正しい位置に表示
- DrawingCanvasのforwardRef対応
  - useImperativeHandleでcanvas要素への参照を提供
  - DrawingPanelからの直接的なcanvas操作を可能に
- 全51テスト通過維持

### ストローク履歴システム設計検討
#### 問題認識
- ウィンドウリサイズ時に描画内容が消失する問題
- Canvas要素サイズ変更時の自動クリア仕様による影響
- 将来的なUndo/Redo、メーキング動画生成への拡張性要求

#### 設計方針決定
**採用アプローチ：ストローク履歴ベース + 仮想キャンバス**
- 描画データを座標・設定込みで構造化保存
- リサイズ時に全ストロークを新サイズで再描画
- 小さくなった場合はスクロールで全体確認可能

**データ構造設計**
```typescript
interface Stroke {
  id: string
  points: { x: number; y: number }[]
  penSize: number
  penColor: string
  timestamp: number
  duration?: number // メーキング動画用
}

interface CanvasState {
  strokes: Stroke[]
  virtualSize: Size  // 最大描画領域
  viewportSize: Size // 現在表示領域
}
```

**最大描画領域サイズ決定戦略**
- **基準：**お手本画像サイズ（ない場合は1200x800デフォルト）
- **制約：**デバイス画面サイズの90%上限（4K制限付き）
- **最小保証：**現在ビューポートサイズと800x600の大きい方
- **拡張：**過去最大到達サイズを維持（縮小禁止）

**実装段階計画**
1. **Phase 1：**Strokeデータ構造 + 描画記録 + リサイズ再描画
2. **Phase 2：**仮想キャンバス管理 + スクロール対応
3. **Phase 3：**Undo/Redo + メーキング動画 + エクスポート

**期待効果**
- ✅ リサイズ時の描画内容保持
- ✅ 将来機能への拡張基盤
- ✅ 模写アプリとしての実用性向上
- ✅ 異なる解像度での品質維持

### Phase 1: ストローク履歴システム実装完了
#### 新規ファイル作成
- **`src/types/drawing.ts`**: 描画システム型定義
  - DrawingPoint, Stroke, CanvasState, DrawingContext インターフェイス
  - 将来的なタブレット対応・メーキング動画対応を考慮した設計
- **`src/hooks/useDrawingStrokes.ts`**: ストローク管理カスタムフック
  - 描画時のストローク情報記録・管理
  - リアルタイム描画とストローク履歴の分離
  - 全ストローク再描画システム

#### 既存コンポーネント改修
- **DrawingCanvas**: ストローク方式への完全移行
  - 従来のCanvasAPI直接描画からストローク記録ベースに変更
  - リサイズ時の自動再描画機能追加
  - forwardRef対応でクリア機能を外部公開
- **DrawingPanel**: クリア機能の統合管理
  - DrawingCanvasRefを通じたクリア操作
  - ストローク履歴との連携強化

#### TypeScript型エラー修正
- `verbatimModuleSyntax`対応: 型のみインポート修正
- テストファイル全般の型安全性向上
- DOMRectモック完全対応
- 未使用変数・インポートの整理

#### 期待効果の実現
- ✅ **リサイズ時描画内容保持**: ウィンドウサイズ変更で描画が消失しない
- ✅ **将来機能への拡張基盤**: Undo/Redo、メーキング動画への対応準備
- ✅ **テスト50件全通過維持**: 品質保証継続
- ✅ **ビルド成功**: TypeScriptエラー完全解決

### Phase 2: 仮想キャンバス + スクロール対応実装完了
#### 新規ファイル作成
- **`src/hooks/useVirtualCanvas.ts`**: 仮想キャンバス管理システム
  - お手本画像サイズ基準の仮想サイズ計算ロジック
  - デバイス制約考慮（90%上限、4K制限付き）
  - 過去最大サイズ保持（縮小防止機能）
  - ビューポート・スクロール状態の動的管理

#### 既存コンポーネント大幅改修
- **DrawingCanvas**: 仮想キャンバス対応
  - ビューポート・仮想コンテナの2層構造実装
  - スクロール対応（overflow: auto/hidden切り替え）
  - 座標系変換（表示座標→仮想キャンバス座標）
  - 仮想サイズ変更時の自動再描画システム
- **App.tsx**: 画像サイズ状態管理
  - お手本画像サイズの一元管理
  - ReferencePanel→DrawingPanelへの画像情報伝達
- **ReferencePanel**: 画像サイズ検出機能
  - 画像読み込み時の naturalWidth/Height 取得
  - onImageDimensionsChange コールバック実装
- **DrawingPanel**: 画像サイズ連携
  - お手本画像サイズをDrawingCanvasに伝達

#### 技術実装の詳細
**仮想キャンバスサイズ決定戦略:**
```typescript
// 基準: お手本画像サイズ（ない場合は1200x800デフォルト）
// 制約: デバイス画面サイズ90%上限（4K制限付き）
// 最小保証: 現在ビューポートサイズと800x600の大きい方
// 拡張: 過去最大到達サイズを維持（縮小禁止）
```

**座標系変換システム:**
```typescript
const virtualX = (event.clientX - rect.left) * (virtualSize.width / rect.width)
const virtualY = (event.clientY - rect.top) * (virtualSize.height / rect.height)
```

**スクロール制御:**
```typescript
overflow: needsScroll ? 'auto' : 'hidden'
// needsScroll = virtualSize > viewportSize
```

#### 期待効果の実現
- ✅ **大画像対応**: お手本画像サイズに合わせた十分な描画領域確保
- ✅ **小画面対応**: スクロールで全体確認可能な柔軟なUI
- ✅ **座標精度**: 正確な描画位置維持（リサイズ・スクロール耐性）
- ✅ **ビルド成功**: TypeScript型安全性維持
- ✅ **開発サーバー動作**: 実際の動作確認可能

#### 緊急修正実施 (2025/6/16 18:00)

##### 問題の発生
- ブラウザでアプリアクセス時にCPU異常消費が発生
- 描画が動作しない状態
- テスト実行時に無限ループが継続

##### 根本原因の特定
1. **useVirtualCanvasの循環依存**：
   - `updateViewportSize`→`imageSize`依存で毎回新参照
   - `updateImageSize`→`viewportSize`依存で毎回新参照
   - これがDrawingCanvasの`useEffect`で無限ResizeObserver作成

2. **redrawAllStrokesの不安定参照**：
   - `strokes`と`currentStroke`依存で毎回新参照
   - 仮想キャンバスサイズ変更時の`useEffect`で無限実行

##### 緊急修正内容
**Phase 1: 複雑機能の一時無効化**
- useVirtualCanvasフック使用停止
- 仮想キャンバス関連のuseEffectを全てコメントアウト
- お手本画像サイズ連携を一時無効化

**Phase 2: 固定サイズキャンバスで安定化**
- 1200×800固定サイズキャンバスに変更
- 座標変換を固定サイズ対応に修正
- ResizeObserver関連の処理を最小化

**Phase 3: ストローク履歴の参照安定化**
- `useRef`でstrokes/currentStrokeの最新値保持
- `redrawAllStrokes`の依存関係を空配列に変更
- コールバック参照の循環更新を防止

##### 修正結果
- ✅ **50テスト全通過**: 無限ループ完全解消
- ✅ **CPU負荷正常化**: ブラウザでの異常消費解決
- ✅ **描画機能復活**: マウス描画が正常動作
- ✅ **アプリ起動成功**: http://localhost:5173/ 正常稼働

##### 一時的に無効な機能
- ❌ リサイズ時のストローク保持（Canvas内容がクリアされる）
- ❌ お手本画像サイズに応じた動的キャンバスサイズ
- ❌ スクロール対応の仮想キャンバス機能

##### 今後の対応方針
1. 基本描画機能の安定運用を優先
2. 仮想キャンバス機能は依存関係を根本から見直し後に再実装
3. useEffectの依存関係設計を慎重に検討

#### リサイズ・パフォーマンス問題修正 (2025/6/16 18:10)

##### 問題の発生
- 描画中のチラツキ問題: ✅ 解決済み
- リサイズ時の描画歪み問題: ❌ 未解決
- 非常に重い描画問題: ❌ 新たに発生
- アンチエイリアスによる線のぼやけ: ❌ 発生中

##### 段階的修正の実施

**Step 1: 描画中チラツキ修正**
- `useEffect`依存関係から`isDrawing`除外
- 描画完了時の不要再描画削除

**Step 2: 動的キャンバスサイズ対応**
- 固定1200×800から動的サイズに変更
- 内部解像度と表示サイズを1:1に統一
- 座標変換を単純化（直接座標使用）

**Step 3: パフォーマンス最適化**
- 描画中のリサイズ処理無効化
- 不要なスケーリング処理削除
- DPR対応によるハイDPI支援

**Step 4: アンチエイリアス対策（部分的）**
- `context.imageSmoothingEnabled = false`
- `imageRendering: 'pixelated'`

##### 修正結果
- ✅ **リサイズ時歪み解決**: 1:1座標系で正確な形状保持
- ✅ **パフォーマンス改善**: 適切な解像度で処理負荷軽減
- ✅ **描画中チラツキ解消**: 不要な再描画削除
- ❌ **アンチエイリアス**: 線のぼやけが残存（次回対応予定）

##### 技術的改善点
```typescript
// 修正前: 複雑なスケーリング
内部: 1200×800固定 → CSS: 100%スケール → 座標変換複雑

// 修正後: シンプルな1:1対応
内部: コンテナサイズと同一 → CSS: 実サイズ → 座標変換不要
```

## MVP完成・機能拡張完了
- ✅ お手本表示（画像アップロード・グリッド）
- ✅ 描画機能（Canvas・ペン設定）
- ✅ 左右分割レイアウト  
- ✅ 完全TDD開発
- ✅ 全51テスト通過
- ✅ Canvas座標ズレ修正
- ✅ UI/UX改善調整
- ✅ グリッド同期・サイズ同期実装
- ✅ 背景色調整・表示範囲最適化

