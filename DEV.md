# DEV.md

## 概要
- イラスト模写支援アプリケーションの設計
- ブラウザで動作するWebアプリケーション
- 画面を左右に分割し、以下のような機能をそれぞれ提供する：
	- イラストを読み込み、お手本として表示する（左）
	- 簡単なドローイング機能を提供し、模写練習ができる（右）

## 機能要件
### お手本画面
- お手本画像は保存できる
	- 後から開き直すこともできるようにする
	- ファイルの実体はWebアプリケーションが起動しているサーバのローカルに保存する
	- 既に保存済みのお手本画像を読み込もうとした場合、警告を表示してから既存のお手本を読み込む
- お手本にはグリッドをオーバーレイできる
	- グリッドの縦横間隔、グリッド線の太さなどは簡単に変更できる
- お手本画面では点と点の長さを測定したり、線と線の角度を測定できる
	- 測定結果は永続化し、お手本を読み込んだ時に復元できる
### ドローイング画面
- ペンの太さを変更できる
	- px単位で指定する
	- 最初は固定値でよい
- ペンの色を変更できる
	- カラーピッカーで色を選択できる
	- 最初は黒のみでよい
- 描いた絵は保存できる
	- お手本のIDと紐付ける。お手本を読み込むと描いた絵が一覧できる
### 共通
- ドローイング画面で描いた絵にお手本を重ねて、ずれを可視化できる
- 左右両方の画面をそれぞれ左右反転して、歪みを確認できる

## 技術要件
- Viteサーバ + ReactのシンプルなWebアプリとする
- 永続化が必要なデータにはSQLiteを用いる
- テストフレームワークとしてVitestを使用する

## Logs

### 2025/6/16 - プロジェクト確認
- リポジトリ内容を確認
- 現在の状態：初期Vite+Reactテンプレート
- 設計仕様をDEV.mdで確認完了

#### MVP構成要素の考察
**必須機能（Core MVP）**
- お手本画像のアップロード・表示
- 基本的な固定間隔グリッドオーバーレイ
- Canvas要素での基本描画機能
- ペンの太さ調整（3-4段階）
- 描画クリア機能
- 左右分割レイアウト

**重要だが後回し可能**
- 描画データ永続化
- お手本画像保存
- 測定機能
- 重ね合わせ機能
- 左右反転
- カラーピッカー

**技術選択**
- フロントエンド：React + Canvas API + CSS Grid
- 永続化は後回し（LocalStorageで代替検討）

#### 実装開始点の検討
**実装順序（TDD前提）**
1. テスト環境構築（Vitest + Testing Library）
2. 基盤レイアウト（左右分割）
3. お手本表示機能（ファイルアップロード・画像表示・グリッド）
4. 描画機能（Canvas描画・ペン設定）

**理由**
- テスト環境を最初に構築してTDD体制確立
- レイアウトでコンポーネント境界を明確化
- お手本機能でユーザー体験の基礎を構築
- Canvas描画は複雑なため最後に集中

### テスト環境構築完了
- Vitest + React Testing Library + jsdom導入
- 基本テストユーティリティ作成（src/test/test-utils.tsx）
- テストスクリプト追加（test, test:ui, test:run）
- 動作確認完了（2テスト通過）

### 基盤レイアウト実装完了（TDD）
- SplitLayoutコンポーネント作成
  - 左右分割（お手本表示/描画エリア）
  - アクセシビリティ対応（role, aria-label）
  - CSS Grid使用
- ウィンドウフルスクリーン対応
  - body, html, #rootの制約解除
  - 100vw × 100vh完全活用
  - 明るいテーマに変更（描画アプリに適用）
- テスト5件全通過

### お手本表示機能実装完了（TDD）
- ImageUploadコンポーネント（5テスト）
  - ファイル選択・ドラッグ&ドロップ対応
  - 画像ファイル形式検証
- ImageDisplayコンポーネント（6テスト）
  - 画像表示・プレースホルダー表示
  - レスポンシブ対応
- GridOverlayコンポーネント（6テスト）
  - SVGベースグリッド描画
  - サイズ・色・線幅カスタマイズ
- ReferencePanelコンポーネント（7テスト）
  - 上記3コンポーネント統合
  - グリッド設定UI
  - 状態管理（画像・グリッド設定）
- App.tsxに統合完了
- 全30テスト通過

### 描画機能実装完了（TDD）
- DrawingCanvasコンポーネント（9テスト）
  - マウス描画対応（mousedown/move/up）
  - Canvas API使用
  - ペン設定適用（太さ・色）
  - クリア機能
- PenControlsコンポーネント（11テスト）
  - ペンサイズ調整（1-100px）
  - プリセットサイズ（細・中・太）
  - カラーピッカー
  - バリデーション機能
- DrawingPanelコンポーネント
  - 上記2コンポーネント統合
  - 状態管理（ペン設定）
- App.tsxに統合完了
- 全50テスト通過

### Canvas座標ズレ修正
- ウィンドウサイズ変更時の座標ズレ問題を修正
- Canvas要素のスケーリング対応
  - 表示サイズと内部座標系のスケール比計算
  - マウス座標の正確な変換
- スケーリングテストケース追加（1テスト）
- 全51テスト通過

### UI/UX改善調整
- ペンの太さを1/2/3pxに調整
  - プリセットサイズ変更（細1px・中2px・太3px）
  - デフォルトサイズ1pxに変更
- お手本とキャンバスの真横配置実現
  - コントロール部分の高さ統一（120px固定）
  - パディング調整で縦位置揃え
  - 模写しやすいレイアウト完成
- 全51テスト通過

### グリッド機能拡張・サイズ同期実装
- 背景色調整機能実装
  - お手本・描画エリア以外を薄いグレー（#f5f5f5）に色付け
  - コントロールパネルは白色のまま維持
- グリッド同期機能実装
  - 描画画面にもグリッドオーバーレイ表示
  - App.tsxでグリッド設定を一元管理
  - 両画面で同じグリッド設定を共有
- グリッド表示範囲最適化
  - お手本画像のグリッドを画像サイズに限定
  - ImageDisplayにサイズ検出機能追加（ResizeObserver）
  - 描画領域のサイズをお手本画像と同期
- コンポーネント間の状態共有強化
  - ReferencePanel → ImageDisplay → App.tsx → DrawingPanel → DrawingCanvas
  - 画像サイズ情報の伝播とキャンバスサイズ同期
- テスト更新・修正
  - ResizeObserverのモック追加
  - 新しいプロパティに対応したテストケース修正
  - 全51テスト通過維持

### 性能問題修正・描画領域最適化
- 描画性能問題とグリッド表示問題を修正
  - 複雑な状態連携による負荷増大問題を解決
  - ペンのガタガタ現象解消
- 前バージョンの仕様に復帰
  - サイズ同期の複雑な実装を単純化
  - コンポーネント間の不要な依存関係を除去
  - ImageDisplayのResizeObserver機能を削除
- 描画側領域の全面表示実装
  - 描画キャンバスを固定サイズ（800×600）に戻す
  - 描画エリアを全面表示に変更（position: absolute + center配置）
  - 背景色調整維持（#f5f5f5）
  - お手本画像サイズに関係なく自由に模写可能
- グリッド表示の正常化
  - 両画面でグリッド表示が正常に動作
  - シンプルなオーバーレイ実装を維持
- 全51テスト通過維持

### 真の全面描画・固定サイズ表示実装
- 描画領域をゾーン全面に拡大（可変サイズ）
  - ResizeObserverでコンテナサイズを監視
  - キャンバスサイズを動的に調整
  - position: absolute + 100%幅高さで完全活用
  - ゾーンサイズ変更に即座に対応
- お手本画像をリサイズせずに表示
  - 画像の元サイズを保持
  - overflow: autoでスクロール可能
  - position: absolute + top-left固定配置
  - ウィンドウサイズ変更による影響を排除
- グリッドと画像の位置関係を固定
  - グリッドをコンテナ全体にオーバーレイ
  - 画像位置に関係なく一定のグリッド表示
  - スクロール時もグリッドは固定位置
  - 正確な位置関係での模写練習が可能
- 全51テスト通過維持

## MVP完成・機能拡張完了
- ✅ お手本表示（画像アップロード・グリッド）
- ✅ 描画機能（Canvas・ペン設定）
- ✅ 左右分割レイアウト  
- ✅ 完全TDD開発
- ✅ 全51テスト通過
- ✅ Canvas座標ズレ修正
- ✅ UI/UX改善調整
- ✅ グリッド同期・サイズ同期実装
- ✅ 背景色調整・表示範囲最適化

